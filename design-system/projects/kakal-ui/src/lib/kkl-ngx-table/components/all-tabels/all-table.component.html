<!-- <ng-container *ngIf="noMobile || !(mobile$ | async); else webBlock"> -->
<div class="all-table-form" (resized)="onResize($event)" #myIdentifier>
  <div class="button-wrapper">
    <button
      class="button-center-start"
      *ngIf="newRowAction"
      kkl-border
      [thick]="2"
      mat-stroked-button
      color="primary"
      (click)="addNewRowGroup()"
    >
      {{ newRowAction }}
      <mat-icon>add</mat-icon>
    </button>
  </div>
  <div
    class="table-wrapper-wrapper"
    fxLayout="column"
    fxLayoutAlign="start"
    fxLayoutGap="1rem"
    [ngClass]="{ 'hidden-class': !isDesktop }"
  >
    <div class="table-wrapper" [ngClass]="{ 'hidden-class': oneColumns.length > viewSize }">
      <!-- cdkDropList
      (cdkDropListDropped)="dropTable($event)" [cdkDropListDisabled]="dragDisabled"> -->
      <!-- [cdkDropListData]="dataTable" -->
      <mat-progress-bar
        mode="indeterminate"
        *ngIf="isLoading"
      ></mat-progress-bar>

      <ngx-datatable
        dir="rtl"
        #myTable
        class="expandable"
        [columnMode]="ColumnMode.force"
        [headerHeight]="35"
        [footerHeight]="paging? 65 : 0"
        rowHeight="auto"
        [rows]="dataTable"
        [offset]="typeLocal? page.pageIndex : 0"
        [limit]="page.pageSize"
        [rowClass]="getRowClass"
        [summaryRow]="hasSummary"
        [summaryPosition]="'bottom'"
        [summaryHeight]="55"
      >
        <!-- Row Detail Template -->
        <ngx-datatable-row-detail [rowHeight]="expandHeight" #myDetailRow>
          <ng-template
            let-row="row"
            let-expanded="expanded"
            ngx-datatable-row-detail-template
          >
            <div *ngIf="expanded" class="example-element-detail" #myExpand>
              <ng-container *ngIf="expandTemplate">
                <ng-template
                  *ngTemplateOutlet="
                    expandTemplate;
                    context: { $implicit: row }
                  "
                ></ng-template>
              </ng-container>
            </div>
          </ng-template>
        </ngx-datatable-row-detail>
        <ngx-datatable-column
          *ngFor="let column of oneColumns"
          [name]="column.key"
          [summaryFunc]="column.sumFunc"
        >
          <!-- style="background-color: blue;" -->
          <ng-template let-sort="sortFn" ngx-datatable-header-template>
            <!-- column.controlType === 'number' || column.controlType === 'sum' -->
            <span>{{ column.label }}</span>
            <button
              *ngIf="!column.noFilter"
              mat-icon-button
              [matMenuTriggerFor]="menu"
            >
              <mat-icon class="arrow-down">arrow_drop_down</mat-icon>
            </button>
            <mat-menu #menu="matMenu" (closed)="searchChanged()">
              <div class="table-filter-wrapper">
                <kkl-table-form
                  [formGroup]="searchRow"
                  [question]="column"
                ></kkl-table-form>
                <kkl-sort-button (sortChange)="sort()"></kkl-sort-button>
              </div>
            </mat-menu>
          </ng-template>
          <ng-template
            let-row="row"
            let-value="value"
            ngx-datatable-cell-template
          >
            <ng-container
              *ngIf="
                !(row | arrInclueds: editItems) || column.notEditable;
                else editBlock
              "
            >
              <kkl-table-cell
                [row]="row" [data]="value"
                [question]="column"
                (buttClick)="buttonClick(column.button, row, column.key)"
                [colsTemplate]="colsTemplate"
              ></kkl-table-cell>
            </ng-container>
            <ng-template #editBlock>
              <kkl-ngx-table-form
                [initial]="editItemsData[row | arrIndex: editItems]"
                [question]="column"
                (rowEdited)="onRowEditChange($event, row, column.key)"
              ></kkl-ngx-table-form>
            </ng-template>
          </ng-template>
        </ngx-datatable-column>
        <ngx-datatable-column *ngIf="localButtons?.length" name="פעולות">
          <ng-template
            let-row="row"
            let-rowIndex="rowIndex"
            ngx-datatable-cell-template
          >
            <ng-container
              *ngTemplateOutlet="
              !(row | arrInclueds: editItems)
              ? actions : addButtonTemplate;
              context: { $implicit: row }"
            ></ng-container>
          </ng-template>
        </ngx-datatable-column>

        <ngx-datatable-footer>
          <ng-template
            ngx-datatable-footer-template
            let-rowCount="rowCount"
            let-pageSize="pageSize"
            let-selectedCount="selectedCount"
            let-curPage="curPage"
            let-offset="offset"
            let-isVisible="isVisible"
          >
            <div class="container">
              <ng-container *ngIf="paging">
                <mat-paginator
                  class="kkl-pagination"
                  #myPaging
                  fxLayout="row"
                  fxLayoutAlign="center center"
                  kklNewPagination
                  [pageIndex]="offset"
                  [pageSize]="pageSize"
                  [length]="rowCount"
                  [pageSizeOptions]="[5, 10, 25]"
                  [showFirstLastButtons]="true"
                  (page)="pageChanged($event)"
                ></mat-paginator>
              </ng-container>
            </div>
          </ng-template>
        </ngx-datatable-footer>
      </ngx-datatable>
    </div>
    <div [ngClass]="{ 'hidden-class': !(oneColumns.length > viewSize) }">
      <ng-container *ngIf="dataTable">
        <div
          *ngFor="let item of dataTable; let i = index"
          class="tablet"
        >
          <mat-card
            class="card"
            *ngIf="
              !paging ||
              (i >= page.pageIndex * page.pageSize &&
              (page.pageIndex + 1) * page.pageSize > i)
            "
          >
            <div fxLayout="row" fxLayoutGap="3rem">
              <kkl-typography [size]="2" [weight]="600">
                {{headline}} {{i + 1}}
              </kkl-typography>
              <div fxLayout="row wrap">
                <tr *ngFor="let col of oneColumns">
                  <ng-container
                    *ngIf="
                      !(item | arrInclueds: editItems) || col.notEditable;
                      else editBlock
                    "
                  >
                    <header>
                      <span class="kkl-display-group-label">
                        {{ col.label }}
                      </span>
                    </header>
                    <td>
                      <kkl-table-cell
                        [row]="item"
                        [data]="item[col.key]"
                        [question]="col"
                        (buttClick)="buttonClick(col.button, item, col.key)"
                        [colsTemplate]="colsTemplate"
                      ></kkl-table-cell>
                    </td>
                  </ng-container>
                  <ng-template #editBlock>
                    <td colspan="2">
                      <kkl-ngx-table-form
                        [initial]="editItemsData[item | arrIndex: editItems]"
                        [question]="col"
                        (rowEdited)="onRowEditChange($event, item, col.key)"
                      ></kkl-ngx-table-form>
                    </td>
                  </ng-template>
                </tr>
                <tr *ngIf="localButtons?.length">
                  <header>
                    <span class="kkl-display-group-label">
                      פעולות
                    </span>
                  </header>
                  <td class="actions" fxLayoutAlign="space-evenly">
                    <ng-container
                      *ngTemplateOutlet="
                      !(item | arrInclueds: editItems)
                      ? actions : addButtonTemplate;
                      context: { $implicit: item }"
                    ></ng-container>
                  </td>
                </tr>
              </div>
            </div>
            <div
              *ngIf="item | arrInclueds: expanded"
              class="example-element-detail"
            >
              <ng-container *ngIf="expandTemplate">
                <ng-template
                  *ngTemplateOutlet="
                    expandTemplate;
                    context: { $implicit: item }
                  "
                ></ng-template>
              </ng-container>
            </div>
          </mat-card>
        </div>
        <div *ngIf="paging">
          <mat-paginator
          class="kkl-pagination"
          #myPaging
          dir="rtl"
          kklNewPagination
          [pageIndex]="page.pageIndex"
          [pageSize]="page.pageSize"
          [length]="dataTable.length"
          [pageSizeOptions]="[5, 10, 25]"
          (page)="pageChanged($event)"
          ></mat-paginator>
        </div>
      </ng-container>

    </div>
  </div>

  <div [ngClass]="{ 'hidden-class': isDesktop }">
    <ng-container *ngIf="dataTable">
      <mat-accordion class="example-headers-align" multi dir="rtl">
        <ng-container *ngFor="let item of dataTable; let i = index">
          <mat-expansion-panel
            class="expansion-panel"
            style="margin: 8px 8px"
            *ngIf="
              !paging ||
              (i >= page.pageIndex * page.pageSize &&
                (page.pageIndex + 1) * page.pageSize > i)
            "
            [hideToggle]="true"
          >
            <mat-expansion-panel-header
              style="height: 10rem"
              class="expansion-panel-header"
            >
              <mat-panel-title>
                    <span style="width: 100%" fxLayout="row">
                      <h1 style="font-weight: bolder; padding: 14.5px 0 0 30px">
                        {{headline}} {{i + 1}}
                      </h1>
                      <span></span>
                    </span>
                    <span
                      style="height: 100%"
                      fxLayout="column"
                      fxLayoutAlign="start"
                    >
                      <kkl-icon
                        class="mobile-drop-down"
                        style="margin-top: 2.2rem"
                        color="primary"
                        key="mobile_drop_down"
                      ></kkl-icon>
                    </span>
              </mat-panel-title>
            </mat-expansion-panel-header>

            <table
              style="
                width: 100%;
                border-spacing: 0 10px;
                border-top: 1px solid #e4e4e4;
              "
            >
              <tr *ngFor="let col of oneColumns">
                  <ng-container
                    *ngIf="
                      !(item | arrInclueds: editItems) || col.notEditable;
                      else editBlock
                    "
                  >
                    <td
                      style="
                        height: 6rem;
                        font-weight: bolder;
                        border-bottom: 1px solid #e4e4e4;
                        width: 40%;
                      "
                    >
                      {{ col.label }}
                    </td>
                    <td style="height: 6rem; border-bottom: 1px solid #e4e4e4">
                      <kkl-table-cell
                        [row]="item"
                        [data]="item[col.key]"
                        [question]="col"
                        (buttClick)="buttonClick(col.button, item, col.key)"
                        [colsTemplate]="colsTemplate"
                      ></kkl-table-cell>
                    </td>
                  </ng-container>
                  <ng-template #editBlock>
                    <td colspan="2">
                      <kkl-ngx-table-form
                        [initial]="editItemsData[item | arrIndex: editItems]"
                        [question]="col"
                        (rowEdited)="onRowEditChange($event, item, col.key)"
                      ></kkl-ngx-table-form>
                    </td>
                  </ng-template>
              </tr>
              <tr *ngIf="localButtons?.length">
                <td style="font-weight: bolder">פעולות</td>
                <td class="actions" fxLayoutAlign="space-evenly">
                    <ng-container
                      *ngTemplateOutlet="
                      !(item | arrInclueds: editItems)
                      ? actions : addButtonTemplate;
                      context: { $implicit: item }"
                    ></ng-container>
                </td>
              </tr>
            </table>

            <div
              *ngIf="item | arrInclueds: expanded"
              class="example-element-detail"
            >
              <ng-container *ngIf="expandTemplate">
                <ng-template
                  *ngTemplateOutlet="
                    expandTemplate;
                    context: { $implicit: item }
                  "
                ></ng-template>
              </ng-container>
            </div>
          </mat-expansion-panel>
        </ng-container>
      </mat-accordion>
    </ng-container>
    <div *ngIf="paging">
      <mat-paginator
        class="kkl-pagination"
        #myPaging
        kklNewPagination
        dir="rtl"
        [pageIndex]="page.pageIndex"
        [pageSize]="page.pageSize"
        [length]="dataTable.length"
        [pageSizeOptions]="[5, 10, 25]"
        [showFirstLastButtons]="true"
        (page)="pageChanged($event)"
      ></mat-paginator>
    </div>
  </div>
</div>


<ng-template #actions let-element>
  <ng-container *ngFor="let butt of localButtons">
    <button
      [matTooltip]="butt.label"
      mat-icon-button
      color="primary"
      (click)="buttonClick(butt, element, 'actions')"
    >
      <kkl-icon *ngIf="butt.icon" [key]="butt.icon"></kkl-icon>
    </button>
  </ng-container>
</ng-template>


<ng-template #addButtonTemplate let-element>
  <kkl-stroke-button
    table-save-button
    color="primary"
    (clickEvent)="saveRowClick(element)"
  >
    שמור
  </kkl-stroke-button>
  <button matTooltip="בטל" mat-icon-button (click)="cancelRowClick(element)">
    <kkl-icon key="cancel"></kkl-icon>
  </button>
</ng-template>
