<!-- <ng-container *ngIf="noMobile || !(mobile$ | async); else webBlock"> -->
<div
  dir="rtl"
  class="kkl-ngx-local-table-wrapper"
  (resized)="onResize($event)"
  #wrapperRef
  fxLayout="column"
  fxLayoutGap="1rem"
>
  <header
    fxLayout="row"
    fxLayoutAlign.sm="end"
    fxLayoutAlign.gt-sm="end"
    fxLayoutAlign.lt-sm="center"
  >
    <ng-container *ngIf="newRowAction">
      <kkl-add-button
        table-add-button
        color="primary"
        (clickEvent)="onNewRowEvent()"
      >
        {{ newRowAction }}
      </kkl-add-button>
    </ng-container>
  </header>

  <!-- DESKTOP TABLE -->

  <main
    class="table-wrapper-wrapper"
    fxLayout="column"
    fxLayoutAlign="start"
    fxLayoutGap="1rem"
    [ngClass]="{ 'hidden-class': !isDesktop }"
  >
    <div
      class="table-wrapper"
      [ngClass]="{ 'hidden-class': oneColumns.length > viewSize }"
    >
      <!-- cdkDropList
      (cdkDropListDropped)="dropTable($event)" [cdkDropListDisabled]="dragDisabled"> -->
      <!-- [cdkDropListData]="dataTable" -->
      <mat-progress-bar
        mode="indeterminate"
        *ngIf="isLoading"
      ></mat-progress-bar>

      <ngx-datatable
        fxFlex
        #tableRef
        class="expandable"
        [columnMode]="ColumnMode.force"
        [headerHeight]="35"
        [footerHeight]="paging ? 65 : 0"
        rowHeight="auto"
        [rows]="dataTable"
        [offset]="page.pageIndex"
        [limit]="page.pageSize"
        [rowClass]="getRowClass"
        [summaryRow]="hasSummary"
        [summaryPosition]="'bottom'"
        [summaryHeight]="55"
      >
        <!-- Row Detail Template -->
        <ngx-datatable-row-detail [rowHeight]="expandHeight" #detailRowRef>
          <ng-template
            let-row="row"
            let-expanded="expanded"
            ngx-datatable-row-detail-template
          >
            <div *ngIf="expanded" class="example-element-detail" #expandRef>
              <ng-container *ngIf="expandTemplate">
                <ng-template
                  *ngTemplateOutlet="
                    expandTemplate;
                    context: { $implicit: row }
                  "
                ></ng-template>
              </ng-container>
            </div>
          </ng-template>
        </ngx-datatable-row-detail>

        <ng-container *ngFor="let column of oneColumns">
          <ngx-datatable-column
            [name]="column.key"
            [summaryFunc]="column.sumFunc"
          >
            <!-- style="background-color: blue;" -->
            <ng-template let-sort="sortFn" ngx-datatable-header-template>
              <!-- column.controlType === 'number' || column.controlType === 'sum' -->
              <span>{{ column.label }}</span>
              <button
                *ngIf="!column.noFilter"
                mat-icon-button
                [matMenuTriggerFor]="menu"
              >
                <mat-icon class="arrow-down">arrow_drop_down</mat-icon>
              </button>
              <mat-menu #menu="matMenu" (closed)="onSearchChanged()">
                <kkl-ngx-table-form
                  [column]="column"
                  (rowEdited)="onFilterChanged($event, column.key)"
                ></kkl-ngx-table-form>
                <kkl-sort-button (click)="sort()"></kkl-sort-button>
              </mat-menu>
            </ng-template>
            <ng-template
              let-row="row"
              let-value="value"
              let-rowIndex="rowIndex"
              ngx-datatable-cell-template
            >
              <ng-container
                *ngTemplateOutlet=" (!(row | arrIncludes: editItems) || column.notEditable ) ? dataTemplate : editTemplate; context {$implicit : row, column, rowIndex, value}"
              ></ng-container>
              <!-- <ng-container
                *ngIf="
                  !(row | arrIncludes: editItems) || column.notEditable;
                  else editBlock
                "
              >
                <kkl-table-cell
                  [row]="row"
                  [data]="value"
                  [column]="column"
                  (actionClicked)="
                    onActionClicked(column.button, row, column.key, rowIndex)
                  "
                  [colsTemplate]="colsTemplate"
                ></kkl-table-cell>
              </ng-container> -->

              <!-- <ng-template #editBlock>
                <kkl-ngx-table-form
                  [initial]="editItemsData[row | arrIndex: editItems]"
                  [question]="column"
                  (rowEdited)="onRowEditChange($event, row, column.key, rowIndex)"
                ></kkl-ngx-table-form>
              </ng-template> -->
            </ng-template>
          </ngx-datatable-column>
        </ng-container>

        <ng-container *ngIf="localButtons?.length">
          <ngx-datatable-column name="פעולות" class="actions-cell">
            <ng-template
              let-row="row"
              let-rowIndex="rowIndex"
              ngx-datatable-cell-template
            >
              <ng-container
                *ngTemplateOutlet="
                  !(row | arrIncludes: editItems)
                    ? actionsTemplate
                    : addButtonTemplate;
                  context: { $implicit: row }
                "
              ></ng-container>
            </ng-template>
          </ngx-datatable-column>
        </ng-container>

        <ngx-datatable-footer>
          <ng-template
            ngx-datatable-footer-template
            let-rowCount="rowCount"
            let-pageSize="pageSize"
            let-selectedCount="selectedCount"
            let-curPage="curPage"
            let-offset="offset"
            let-isVisible="isVisible"
          >
            <div class="container">
              <ng-container *ngIf="paging">
                <mat-paginator
                  class="kkl-pagination"
                  #myPaging
                  fxLayout="row"
                  fxLayoutAlign="center center"
                  kklNewPagination
                  [pageIndex]="offset"
                  [pageSize]="pageSize"
                  [length]="rowCount"
                  [pageSizeOptions]="[5, 10, 25]"
                  [showFirstLastButtons]="true"
                  (page)="onPageChanged($event)"
                ></mat-paginator>
              </ng-container>
            </div>
          </ng-template>
        </ngx-datatable-footer>
      </ngx-datatable>
    </div>
    <div [ngClass]="{ 'hidden-class': !(oneColumns.length > viewSize) }">
      <ng-container *ngFor="let item of dataTable; let rowIndex = index">
        <div class="tablet">
          <mat-card
            *ngIf="
              !paging ||
              (rowIndex >= page.pageIndex * page.pageSize &&
                (page.pageIndex + 1) * page.pageSize > rowIndex)
            "
          >
            <div fxLayout="row" fxLayoutGap="3rem">
              <ng-container
                *ngTemplateOutlet="headlineTemplate; context: { $implicit: rowIndex }"
              ></ng-container>
              <div fxLayout="row wrap">
                <ng-container *ngFor="let col of oneColumns">
                  <tr>
                    <ng-container
                      *ngIf="
                        !(item | arrIncludes: editItems) || col.notEditable;
                        else editBlock
                      "
                    >
                      <header>
                        <span class="kkl-display-group-label">
                          {{ col.label }}
                        </span>
                      </header>
                      <td>
                        <kkl-table-cell
                          [row]="item"
                          [data]="item[col.key]"
                          [column]="col"
                          (actionClicked)="
                            onActionClicked(col.button, item, col.key, rowIndex)
                          "
                          [colsTemplate]="colsTemplate"
                        ></kkl-table-cell>
                      </td>
                    </ng-container>
                    <ng-template #editBlock>
                      <td colspan="2">
                        <kkl-ngx-table-form
                          [initial]="editItemsData[item | arrIndex: editItems]"
                          [column]="col"
                          (rowEdited)="onRowEditChange($event, item, col.key)"
                        ></kkl-ngx-table-form>
                      </td>
                    </ng-template>
                  </tr>
                </ng-container>

                <ng-container *ngIf="localButtons?.length">
                  <tr>
                    <header>
                      <span class="kkl-display-group-label"> פעולות </span>
                    </header>
                    <td class="actionsTemplate" fxLayoutAlign="space-evenly">
                      <ng-container
                        *ngTemplateOutlet="
                          !(item | arrIncludes: editItems)
                            ? actionsTemplate
                            : addButtonTemplate;
                          context: { $implicit: item }
                        "
                      ></ng-container>
                    </td>
                  </tr>
                </ng-container>
              </div>
            </div>
            <ng-container *ngIf="item | arrIncludes: expanded">
              <div class="example-element-detail">
                <ng-container *ngIf="expandTemplate">
                  <ng-template
                    *ngTemplateOutlet="
                      expandTemplate;
                      context: { $implicit: item }
                    "
                  ></ng-template>
                </ng-container>
              </div>
            </ng-container>
          </mat-card>
        </div>
        <div *ngIf="paging">
          <mat-paginator
            class="kkl-pagination"
            #myPaging
            dir="rtl"
            kklNewPagination
            [pageIndex]="page.pageIndex"
            [pageSize]="page.pageSize"
            [length]="dataTable.length"
            [pageSizeOptions]="[5, 10, 25]"
            (page)="onPageChanged($event)"
          ></mat-paginator>
        </div>
      </ng-container>
    </div>
  </main>

  <!-- MOBILE TABLE -->
  <main [ngClass]="{ 'hidden-class': isDesktop }">
    <ng-container *ngIf="dataTable">
      <mat-accordion class="example-headers-align" multi dir="rtl">
        <ng-container *ngFor="let item of dataTable; let rowIndex = index">
          <mat-expansion-panel
            class="expansion-panel"
            style="margin: 8px 8px"
            *ngIf="
              !paging ||
              (rowIndex >= page.pageIndex * page.pageSize &&
                (page.pageIndex + 1) * page.pageSize > rowIndex)
            "
            [hideToggle]="true"
          >
            <mat-expansion-panel-header
              style="height: 10rem"
              class="expansion-panel-header"
            >
              <mat-panel-title>
                <span style="width: 100%" fxLayout="row">
                  <h1 style="font-weight: bolder; padding: 14.5px 0 0 30px">
                    {{ headline }}. {{ rowIndex + 1 }}
                  </h1>
                  <span></span>
                </span>
                <span
                  style="height: 100%"
                  fxLayout="column"
                  fxLayoutAlign="start"
                >
                  <kkl-icon
                    class="mobile-drop-down"
                    style="margin-top: 2.2rem"
                    color="primary"
                    key="mobile_drop_down"
                  ></kkl-icon>
                </span>
              </mat-panel-title>
            </mat-expansion-panel-header>

            <table
              style="
                width: 100%;
                border-spacing: 0 10px;
                border-top: 1px solid #e4e4e4;
              "
            >
              <ng-container *ngFor="let col of oneColumns">
                <tr>
                  <ng-container
                    *ngIf="
                      !(item | arrIncludes: editItems) || col.notEditable;
                      else editBlock
                    "
                  >
                    <td
                      style="
                        height: 6rem;
                        font-weight: bolder;
                        border-bottom: 1px solid #e4e4e4;
                        width: 40%;
                      "
                    >
                      {{ col.label }}
                    </td>
                    <td style="height: 6rem; border-bottom: 1px solid #e4e4e4">
                      <kkl-table-cell
                        [row]="item"
                        [data]="item[col.key]"
                        [column]="col"
                        (actionClicked)="
                          onActionClicked(col.button, item, col.key, rowIndex)
                        "
                        [colsTemplate]="colsTemplate"
                      ></kkl-table-cell>
                    </td>
                  </ng-container>
                  <ng-template #editBlock>
                    <td colspan="2">
                      <kkl-ngx-table-form
                        [initial]="editItemsData[item | arrIndex: editItems]"
                        [column]="col"
                        (rowEdited)="onRowEditChange($event, item, col.key)"
                      ></kkl-ngx-table-form>
                    </td>
                  </ng-template>
                </tr>
              </ng-container>

              <ng-container *ngIf="localButtons?.length">
                <tr>
                  <td style="font-weight: bolder">פעולות</td>
                  <td class="actionsTemplate" fxLayoutAlign="space-evenly">
                    <ng-container
                      *ngTemplateOutlet="
                        !(item | arrIncludes: editItems)
                          ? actionsTemplate
                          : addButtonTemplate;
                        context: { $implicit: item }
                      "
                    ></ng-container>
                  </td>
                </tr>
              </ng-container>
            </table>

            <ng-container *ngIf="item | arrIncludes: expanded">
              <div class="example-element-detail">
                <ng-container *ngIf="expandTemplate">
                  <ng-template
                    *ngTemplateOutlet="
                      expandTemplate;
                      context: { $implicit: item }
                    "
                  ></ng-template>
                </ng-container>
              </div>
            </ng-container>
          </mat-expansion-panel>
        </ng-container>
      </mat-accordion>
    </ng-container>

    <ng-container *ngIf="paging">
      <footer>
        <mat-paginator
          class="kkl-pagination"
          #myPaging
          kklNewPagination
          dir="rtl"
          [pageIndex]="page.pageIndex"
          [pageSize]="page.pageSize"
          [length]="dataTable.length"
          [pageSizeOptions]="[5, 10, 25]"
          [showFirstLastButtons]="true"
          (page)="onPageChanged($event)"
        ></mat-paginator>
      </footer>
    </ng-container>
  </main>
</div>

<ng-template
  #dataTemplate
  let-row
  let-column="column"
  let-rowIndex="rowIndex"
  let-value="value"
>
  <kkl-table-cell
    [row]="row"
    [data]="value"
    [column]="column"
    (actionClicked)="onActionClicked(column.button, row, column.key, rowIndex)"
    [colsTemplate]="colsTemplate"
  ></kkl-table-cell>
</ng-template>

<ng-template #editTemplate let-row let-column="column" let-rowIndex="rowIndex">
  <kkl-ngx-table-form
    dir="rtl"
    [initial]="editItemsData[row | arrIndex: editItems]"
    [column]="column"
    (rowEdited)="onRowEditChange($event, row, column.key)"
  ></kkl-ngx-table-form>
</ng-template>

<ng-template #actionsTemplate let-row let-rowIndex="rowIndex">
  <div
    fxFlex="100"
    class="actions"
    fxLayout="row"
    fxLayoutGap=".5rem"
    dir="rtl"
    fxLayoutAlign="end center"
  >
    <ng-container *ngFor="let button of localButtons">
      <ng-container *ngIf="!button.button">
        <button
          [matTooltip]="button.label"
          mat-icon-button
          color="primary"
          (click)="onActionClicked(button, row, 'actions', rowIndex)"
        >
          <kkl-icon *ngIf="button.icon" [key]="button.icon"></kkl-icon>
        </button>
      </ng-container>
      <ng-container *ngIf="button.button">
        <kkl-stroke-button
          kkl-action-table
          color="primary"
          (clickEvent)="onActionClicked(button, row, 'actions', rowIndex)"
        >
          {{ button.label }}
        </kkl-stroke-button>
      </ng-container>
    </ng-container>
  </div>
</ng-template>

<ng-template #addButtonTemplate let-row let-rowIndex="rowIndex">
  <div dir="rtl" fxLayout="row" fxLayoutGap="1rem">
    <kkl-stroke-button
      table-save-button
      color="primary"
      (clickEvent)="onSaveEvent(row, rowIndex)"
    >
      שמור
    </kkl-stroke-button>
    <button
      ma
      tTooltip="בטל"
      mat-icon-button
      (click)="onCancelEvent(row, rowIndex)"
    >
      <kkl-icon key="cancel"></kkl-icon>
    </button>
  </div>
</ng-template>

<ng-template #headlineTemplate let-rowIndex>
  <kkl-typography [size]="2" [weight]="600">
    {{ headline }}. {{ rowIndex + 1 }}
  </kkl-typography>
</ng-template>
