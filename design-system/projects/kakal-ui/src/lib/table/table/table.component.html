<ng-container *ngIf="table$ | async as table">
  <div dir="rtl" fxLayout="column" fxLayoutGap="1rem">
    <mat-table
      mat-table
      [ngClass]="[theme, 'kkl-table']"
      [dataSource]="table.data"
      multiTemplateDataRows
    >
      <!-- HEADER COLUMN -->

      <ng-container>
        <ng-container [matColumnDef]="'headerRow'">
          <mat-header-cell
            *matHeaderCellDef
            [ngClass]="{ expand: expendable || accordion }"
          >
            <div
              [ngClass]="{
                'row-header': true
              }"
              fxFill
              fxLayout="row"
            >
              <!-- COLUMN HEADER SECTION-->

              <div
                appCell
                [span]="column.flex"
                fxLayout="row"
                fxFlexAlign="center center"
                *ngFor="let column of table.columns"
                [class.kkl-cell]="true"
                [class.center]="column.center"
                [class.select]="column.columnDef === 'select'"
                [class.actions]="column.columnDef === 'actions'"
              >
                <!-- DEFAULT HEADER -->
                <ng-container>
                  <kkl-typography>
                    {{ column.label }}
                  </kkl-typography>
                </ng-container>
              </div>
            </div>
          </mat-header-cell>
        </ng-container>
      </ng-container>

      <!-- EXPEND ROW -->
      <ng-container>
        <mat-accordion>
          <ng-container matColumnDef="row">
            <mat-cell
              *matCellDef="let row"
              [ngClass]="{ expand: expendable || accordion }"
              [attr.colspan]="columnDefs.length"
            >
              <mat-expansion-panel
                #panel
                [hideToggle]="true"
                [disabled]="true"
                fxFill
              >
                <mat-expansion-panel-header
                  [ngClass]="{
                    accordion: (accordion || clickable) && !row.editable,
                    form: row.editable
                  }"
                >
                  <div class="row" fxFill fxLayout="row">
                    <ng-container *ngFor="let column of table.columns; let i">
                      <div
                        appCell
                        [span]="column.flex"
                        fxLayout="row"
                        fxFlexAlign="center center"
                        [class.kkl-cell]="true"
                        [class.kkl-item]="true"
                        [class.center]="column.center"
                        [class.select]="column.columnDef === 'select'"
                        [class.actions]="column.columnDef === 'actions'"
                      >
                        <ng-container
                          *ngIf="column.columnDef === 'select'; else cellBlock"
                        >
                          <div>
                            <mat-checkbox
                              color="primary"
                              (click)="onSelect()"
                              [disabled]="column.disableSelect"
                              (change)="$event ? selection.toggle(row) : null"
                              [checked]="selection.isSelected(row)"
                            >
                            </mat-checkbox>
                          </div>
                        </ng-container>

                        <ng-template #cellBlock>
                          <kkl-typography>
                            {{
                              row.item[column.columnDef]
                                | format: column?.format
                            }}
                          </kkl-typography>
                        </ng-template>
                      </div>
                    </ng-container>
                  </div>
                </mat-expansion-panel-header>
              </mat-expansion-panel>
            </mat-cell>
          </ng-container>
        </mat-accordion>
      </ng-container>

      <!-- HEADER ROW -->
      <mat-header-row [ngClass]="[theme]" *matHeaderRowDef="['headerRow']">
      </mat-header-row>

      <mat-row *matRowDef="let row; columns: ['row']"></mat-row>

      <ng-container *ngIf="hasFooter">
        <mat-row
          class="default"
          mat-footer-row
          *matFooterRowDef="columnDefs"
        ></mat-row>
      </ng-container>
    </mat-table>
  </div>
</ng-container>
