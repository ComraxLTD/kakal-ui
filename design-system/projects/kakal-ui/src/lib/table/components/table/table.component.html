<ng-container *ngIf="tableState$ | async as tableState">
  <ng-container *ngIf="table$ | async as table">
    <ng-container *ngIf="data$ | async as data">
      <!-- @Todo: Dvir - the table's state needs to be stored in the table service -->
      <kkl-table-filters
        *ngIf="!hideChipFilters"
        [tableState]="tableState"
      ></kkl-table-filters>

      <div dir="rtl" fxLayout="column" fxLayoutGap="1rem">
        <mat-table
          mat-table
          [ngClass]="[theme, 'kkl-table']"
          [dataSource]="data | paginate: tableState.pagination"
          multiTemplateDataRows
        >
          <ng-container
            [matColumnDef]="column.columnDef"
            *ngFor="let column of table.columns"
          >
            <mat-header-cell *matHeaderCellDef>
              <ng-container
                *ngTemplateOutlet="
            cellHeaderDirective?.template;
      context: { $implicit: {column, key,  tableState}}
      "
              >
              </ng-container>
            </mat-header-cell>

            <mat-cell
              *matCellDef="let item; let itemIndex = dataIndex"
              [class.form]="tableState.editing.indexOf(item[key]) !== -1"
            >
              <ng-container [ngSwitch]="column.columnDef">
                <!-- Select cell -->
                <ng-container *ngSwitchCase="'select'">
                  <mat-checkbox
                    color="primary"
                    (click)="onSelect()"
                    [disabled]="column.disableSelect"
                    (change)="$event ? selection.toggle(item) : null"
                    [checked]="selection.isSelected(item)"
                  >
                  </mat-checkbox>
                </ng-container>

                <!-- Actions cell -->
                <ng-container *ngSwitchCase="'actions'">
                  <ng-container
                    *ngTemplateOutlet="
                  cellActionDirective?.template;
              context: { $implicit: {item , column, itemIndex, key, tableState}}
              "
                  >
                  </ng-container>
                </ng-container>

                <!-- Data cell -->

                <ng-container *ngSwitchDefault>
                  <ng-container
                    *ngTemplateOutlet="
                cellDirective.template;
                context: { $implicit: {item, column, itemIndex, key, tableState}}
                "
                  >
                  </ng-container>
                </ng-container>
              </ng-container>
            </mat-cell>
          </ng-container>

          <!-- <ng-container matColumnDef="form">
          <mat-cell *matCellDef="let item; let itemIndex = dataIndex">
            create action work
          </mat-cell>
        </ng-container> -->

          <!-- HEADER ROW -->
          <mat-header-row
            [ngClass]="[theme]"
            *matHeaderRowDef="table.columnDefs"
          >
          </mat-header-row>

          <!-- TABLE ROW -->
          <mat-row *matRowDef="let row; columns: table.columnDefs"></mat-row>

          <!-- FORM ROW -->
          <!-- <mat-row
          *matRowDef="let row; columns: ['form']; when: isForm"
        ></mat-row> -->

          <!-- FOOTER ROW -->
          <ng-container *ngIf="hasFooter">
            <mat-row
              class="default"
              mat-footer-row
              *matFooterRowDef="columnDefs"
            ></mat-row>
          </ng-container>
        </mat-table>
      </div>
    </ng-container>
  </ng-container>

  <ng-container *ngIf="pagination$ | async">
    <kkl-pagination
      (pageChange)="onPageChange($event)"
      [pagination]="tableState.pagination"
    >
    </kkl-pagination>
  </ng-container>
</ng-container>
