<div fxFill fxLayout="column" fxLayoutGap="1rem" dir="rtl">
  <!-- the checkbox will appear only if the "multi" value is set to true, the checkbox controls and presents weather all panels are open or not -->
  <header>
    <ng-container *ngIf="!(mobile$ | async); else mobileBlock">
      <div fxLayout="row" fxLayoutGap="3rem" fxLayoutAlign="end center">
        <mat-checkbox [color]="'primary'" (change)="expandAll($event)">
          פתח הכול</mat-checkbox
        >
        <kkl-add-button *ngIf="buttonLabel" (click)="onClick()">{{
          buttonLabel
        }}</kkl-add-button>
      </div>
    </ng-container>
    <ng-template #mobileBlock>

      <div fxLayout="column" fxLayoutAlign="center center">
        <kkl-add-button *ngIf="buttonLabel" (click)="onClick()">{{
          buttonLabel
        }}</kkl-add-button>
        <div class="checkbox" fxLayout="row" fxLayoutAlign="end center">
          <mat-checkbox [color]="'primary'" (change)="expandAll($event)">
            פתח הכול</mat-checkbox
          >
        </div>
      </div>
    </ng-template>
  </header>

  <!-- the "multi" attribute determines weather the mat-accordion will allow multiple panels to open at the same time or not -->
  <main>
    <mat-accordion #accordion multi hideToggle>
      <ng-container *ngFor="let panel of panels; let i = index">
        <mat-expansion-panel
          #expandPanel
          [expanded]="i === 0"
          fxLayoutGap="1rem"
          fxLayout="column"
        >
          <mat-expansion-panel-header>
            <mat-panel-title [ngClass]="['default']">
              <div
                class="title"
                fxLayout="row"
                fxLayoutAlign="start center"
                fxLayoutGap="1rem"
              >
                <ng-container
                  *ngTemplateOutlet="
                      panel.headers ? headerTemplate : defaultTemplate;
                      context: { $implicit: panel, i }
                    "
                ></ng-container>

                <kkl-icon
                  color="primary"
                  [key]="
                    expandPanel.expanded
                      ? 'keyboard_arrow_down'
                      : 'keyboard_arrow_up'
                  "
                ></kkl-icon>
              </div>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="content">
            <ng-container
              *ngTemplateOutlet="templates[panel.key]"
            ></ng-container>
          </div>
        </mat-expansion-panel>
      </ng-container>
    </mat-accordion>
  </main>
</div>

<ng-template #defaultTemplate let-panel let-i="i">
  <div>
    <kkl-typography [size]="1.8" [weight]="600" color="primary">
      {{ i + 1 }}.
    </kkl-typography>
    <kkl-typography [size]="1.8" [weight]="600" color="primary">
      {{ panel | pluck: "label" }}
    </kkl-typography>
  </div>
</ng-template>

<ng-template #headerTemplate let-panel>
  <ng-container *ngFor="let header of panel.headers; let i = index">
    <kkl-typography
      color="accent"
      [size]="sizeIndexMap[i]"
      [weight]="weightIndexMap[i]"
    >
      {{
        panel.item
          | pluck: (header | pluck: "key")
          | format: (header | pluck: "format")
      }}
    </kkl-typography>
  </ng-container>
</ng-template>
