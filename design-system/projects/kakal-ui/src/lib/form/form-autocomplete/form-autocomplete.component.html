<mat-form-field
  class="kkl-form-autocomplete"
  [appearance]="control.disabled ? 'fill' : 'outline'"
>
  <mat-label>{{ label }}</mat-label>

  <input
    type="text"
    matInput
    [formControl]="control"
    [matAutocomplete]="auto"
    #autoCompleteInput
    (input)="search(autoCompleteInput.value)"
  />

  <mat-autocomplete
    autoActiveFirstOption
    #auto="matAutocomplete"
    [displayWith]="displayFn"
    (optionSelected)="onOptionSelected($event)"
    [panelWidth]="panelWidth ? 'auto' : null"
  >
    <ng-container *ngIf="!multi">
      <mat-option
        class="kkl-form-autocomplete-option"
        [disabled]="option.disabled"
        *ngFor="let option of options"
        [value]="option"
      >
        <ng-container
          *ngTemplateOutlet="
            optionTemplate || defaultTemplate;
            context: { $implicit: option }
          "
        ></ng-container>
      </mat-option>
    </ng-container>

    <ng-container *ngIf="multi">
      <mat-selection-list
        [multiple]="true"
        #selectionList
        (selectionChange)="onSelectionChange(selectionList)"
      >
        <mat-list-option
          class="kkl-form-autocomplete-list-option"
          [disabled]="option.disabled"
          *ngFor="let option of options"
          [value]="option"
        >
          <ng-container
            *ngTemplateOutlet="
              optionTemplate || defaultTemplate;
              context: { $implicit: option }
            "
          ></ng-container>
        </mat-list-option>
      </mat-selection-list>
      <!-- empty mat-option for display mat-list -->
      <mat-option [style.display]="'none'"></mat-option>
    </ng-container>
  </mat-autocomplete>

  <button
    type="button"
    *ngIf="asButton"
    matSuffix
    mat-icon-button
    (click)="onSearchEvent()"
  >
    <kkl-icon color="primary" [key]="icon || 'search'" [size]="1.8"></kkl-icon>
  </button>

  <kkl-icon
    matSuffix
    *ngIf="!asButton"
    color="primary"
    [key]="icon || 'search'"
    [size]="3"
  ></kkl-icon>
</mat-form-field>

<ng-template #defaultTemplate let-option>
  {{ option | pluck: "label" }}
</ng-template>
