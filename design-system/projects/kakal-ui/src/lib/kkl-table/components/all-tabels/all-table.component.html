<!-- <ng-container *ngIf="noMobile || !(mobile$ | async); else webBlock"> -->
<form
  [formGroup]="form"
  class="all-table-form"
  (resized)="onResize($event)"
  #myIdentifier
>
  <div [ngClass]="{ 'hidden-class': !isDesktop }">
    <div
      *ngIf="displayedColumns.length"
      class="table-wrapper"
      cdkDropList
      (cdkDropListDropped)="dropTable($event)"
      [cdkDropListDisabled]="dragDisabled"
    >
      <!-- [cdkDropListData]="dataTable" -->
      <mat-progress-bar
        mode="indeterminate"
        *ngIf="isLoading"
      ></mat-progress-bar>
      <table
        #table
        dir="rtl"
        mat-table
        [dataSource]="dataTable"
        matSort
        multiTemplateDataRows
        formArrayName="myRows"
        [ngClass]="{ 'expand-table': expandTemplate }"
      >
        <ng-container matColumnDef="dragHandeler">
          <th mat-header-cell *matHeaderCellDef></th>
          <td
            class="dragCursor"
            mat-cell
            *matCellDef="let element"
            [style.display]="''"
            [attr.rowspan]="element == expandedElement ? 1 : 2"
          >
            <div class="example-handle" cdkDragHandle>
              <kkl-icon
                class="dragCursor"
                (mousedown)="dragDisabled = false"
                color="text"
                key="all_directions"
              ></kkl-icon>
            </div>
          </td>
        </ng-container>

        <ng-container
          *ngFor="let column of oneColumns"
          [matColumnDef]="column.key"
        >
          <th mat-header-cell *matHeaderCellDef style="white-space: nowrap">
            <h3 mat-sort-header style="display: inline-block">
              {{ column.label }}
            </h3>
            <button
              *ngIf="!column.noFilter"
              mat-icon-button
              [matMenuTriggerFor]="menu"
            >
              <!-- <kkl-icon class="arrow-down" key="arrow_drop_down"></kkl-icon> -->
              <mat-icon class="arrow-down">arrow_drop_down</mat-icon>
            </button>
            <mat-menu #menu="matMenu" (closed)="searchChanged()">
              <kkl-table-form
                [formGroup]="searchRow"
                [question]="column"
                (rowEdited)="onRowEditChange(-1)"
              ></kkl-table-form>
            </mat-menu>
          </th>
          <td
            mat-cell
            *matCellDef="let element; let i = dataIndex"
            [style.display]="
              (i | tableGroupCell: column.group:spans) ? '' : 'none'
            "
            [attr.rowspan]="
              element == expandedElement
                ? (i | tableGroupCell: column.group:spans)
                : (i | tableGroupCell: column.group:spans) * 2
            "
          >
            <ng-container
              *ngIf="!(element | arrInclueds: editItems); else editBlock"
            >
              <kkl-table-cell
                [data]="element[column.key]"
                [question]="column"
                (buttClick)="buttonClick(column.button, element, column.key)"
                [colsTemplate]="colsTemplate"
              ></kkl-table-cell>
            </ng-container>
            <ng-template #editBlock>
              <ng-container *ngIf="column.notEditable; else innerEditBlock">
                <kkl-table-cell
                  [data]="element[column.key]"
                  [question]="column"
                  (buttClick)="buttonClick(column.button, element, column.key)"
                  [colsTemplate]="colsTemplate"
                ></kkl-table-cell>
              </ng-container>
              <ng-template #innerEditBlock>
                <kkl-table-form
                  [formGroupName]="element | arrIndex: editItems"
                  [question]="column"
                  (rowEdited)="onRowEditChange(element)"
                ></kkl-table-form>
              </ng-template>
            </ng-template>
          </td>
        </ng-container>

        <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
        <ng-container matColumnDef="expandedDetail">
          <td
            [ngClass]="
              element == expandedElement ? 'expanded-container' : 'hide'
            "
            mat-cell
            *matCellDef="let element"
            [attr.colspan]="displayedColumns.length"
          >
            <div
              [@detailExpand]="
                element == expandedElement ? 'expanded' : 'collapsed'
              "
              [ngClass]="element == expandedElement ? 'expand' : ''"
            >
              <div
                *ngIf="element == expandedElement"
                class="example-element-detail"
              >
                <ng-container *ngIf="expandTemplate">
                  <ng-template *ngTemplateOutlet="expandTemplate"></ng-template>
                </ng-container>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="center-butt">
            <button
              class="add-button"
              *ngIf="newRowAction"
              kkl-border
              [thick]="2"
              mat-stroked-button
              color="primary"
              (click)="addNewRowGroup()"
            >
              <span>
                {{ newRowAction }}
              </span>
              <mat-icon>add</mat-icon>
            </button>
            <h3 *ngIf="!newRowAction">פעולות</h3>
          </th>
          <td
            mat-cell
            *matCellDef="let element"
            class="center-butt"
            [style.display]="''"
            [attr.rowspan]="element == expandedElement ? 1 : 2"
          >
            <ng-container
              *ngIf="!(element | arrInclueds: editItems); else addButton"
            >
              <ng-container *ngFor="let butt of localButtons">
                <button
                  [matTooltip]="butt.label"
                  mat-button
                  color="primary"
                  (click)="buttonClick(butt, element, 'actions')"
                >
                  <kkl-icon *ngIf="butt.icon" [key]="butt.icon"></kkl-icon>
                </button>
              </ng-container>
            </ng-container>
            <ng-template #addButton>
              <button
                matTooltip="save"
                mat-button
                color="primary"
                (click)="saveRowClick(element)"
              >
                <kkl-icon key="save"></kkl-icon>
              </button>
              <button
                matTooltip="cancel"
                mat-button
                color="primary"
                (click)="cancelRowClick(element)"
              >
                <kkl-icon key="cancel"></kkl-icon>
              </button>
            </ng-template>
          </td>
        </ng-container>

        <tr
          mat-header-row
          *matHeaderRowDef="displayedColumns; sticky: true"
        ></tr>
        <tr
          mat-row
          *matRowDef="let element; columns: displayedColumns"
          [class.example-expanded-row]="expandedElement === element"
          [class.example-element-row]="expandedElement !== element"
          cdkDrag
          [cdkDragData]="element"
          (click)="onExpandOut(element)"
          [ngClass]="{ 'mat-elevation-z2': expandTemplate }"
        >
          <!-- [ngClass]="{'mat-elevation-z8': expandTemplate}" -->
          <!-- [ngClass]="expandedElement ? '': ''" -->
          <!-- [ngClass]="{'' : expandTemplate}" -->
        </tr>
        <tr
          mat-row
          *matRowDef="
            let row;
            columns: expandTemplate ? ['expandedDetail'] : []
          "
          [ngClass]="{ 'mat-elevation-z2': expandTemplate }"
          class="example-detail-row"
        ></tr>

        <!-- Row shown when there is no matching data. -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="displayedColumns.length">
            <h3 style="text-align: center">No data</h3>
          </td>
        </tr>
      </table>
    </div>
  </div>
  <div [ngClass]="{ 'hidden-class': isDesktop }">
    <ng-container *ngIf="dataTable">
      <!-- <kkl-mobile-table [oneColumns]="oneColumns" [dataSource]="typeLocal? dataTable.filteredData : dataTable"
        [colsTemplate]="colsTemplate" [editItems]="editItems"
      ></kkl-mobile-table> -->
      <button
        class="add-button"
        *ngIf="newRowAction"
        kkl-border
        [thick]="2"
        mat-stroked-button
        color="primary"
        (click)="addNewRowGroup()"
      >
        <span>
          {{ newRowAction }}
        </span>
        <mat-icon>add</mat-icon>
      </button>
      <mat-accordion
        class="example-headers-align"
        multi
        formArrayName="myRows"
        dir="rtl"
      >
        <ng-container
          *ngFor="
            let item of typeLocal ? dataTable?.filteredData : dataTable;
            let i = index
          "
        >
          <mat-expansion-panel
            class="expansion-panel"
            style="margin: 8px 8px"
            *ngIf="
              !paging ||
              (i >= myPaging.pageIndex * myPaging.pageSize &&
                (myPaging.pageIndex + 1) * myPaging.pageSize > i)
            "
            [hideToggle]="true"
          >
            <mat-expansion-panel-header
              style="height: 10rem"
              class="expansion-panel-header"
            >
              <mat-panel-title>
                <table style="width: 100%; height: 100%">
                  <tr fxLayout="row" fxLayoutAlign="space-evenly" fxFlex="100">
                    <span style="width: 100%" fxLayout="row">
                      <td style="font-weight: bolder; padding: 14.5px 0 0 30px">
                        {{ oneColumns[0].label }}
                      </td>
                      <td
                        style="margin-top: 13px"
                        fxLayout="column"
                        fxLayoutAlign="start start"
                      >
                        <kkl-table-cell
                          class="kkl-table-cell"
                          [data]="item[oneColumns[0].key]"
                          [question]="oneColumns[0]"
                          (buttClick)="
                            buttonClick(
                              oneColumns[0].button,
                              item,
                              oneColumns[0].key
                            )
                          "
                          [colsTemplate]="colsTemplate"
                        ></kkl-table-cell>
                      </td>
                      <span></span>
                    </span>
                    <span
                      style="height: 100%"
                      fxLayout="column"
                      fxLayoutAlign="start"
                    >
                      <kkl-icon
                        class="mobile-drop-down"
                        style="margin-top: 2.2rem"
                        color="primary"
                        key="mobile_drop_down"
                      ></kkl-icon>
                    </span>
                  </tr>
                </table>
              </mat-panel-title>
            </mat-expansion-panel-header>

            <table
              style="
                width: 100%;
                border-spacing: 0 10px;
                border-top: 1px solid #e4e4e4;
              "
            >
              <tr *ngFor="let col of oneColumns">
                <ng-container *ngIf="col.key !== oneColumns[0].key">
                  <ng-container
                    *ngIf="!(item | arrInclueds: editItems); else editBlock"
                  >
                    <td
                      style="
                        height: 6rem;
                        font-weight: bolder;
                        border-bottom: 1px solid #e4e4e4;
                      "
                    >
                      {{ col.label }}
                    </td>
                    <td style="height: 6rem; border-bottom: 1px solid #e4e4e4">
                      <kkl-table-cell
                        [data]="item[col.key]"
                        [question]="col"
                        (buttClick)="buttonClick(col.button, item, col.key)"
                        [colsTemplate]="colsTemplate"
                      ></kkl-table-cell>
                    </td>
                  </ng-container>
                  <ng-template #editBlock>
                    <ng-container *ngIf="col.notEditable; else innerEditBlock">
                      <td style="font-weight: bolder">{{ col.label }}</td>
                      <td>
                        <kkl-table-cell
                          [data]="item[col.key]"
                          [question]="col"
                          (buttClick)="buttonClick(col.button, item, col.key)"
                          [colsTemplate]="colsTemplate"
                        ></kkl-table-cell>
                      </td>
                    </ng-container>
                    <ng-template #innerEditBlock>
                      <td colspan="2">
                        <kkl-table-form
                          [formGroupName]="item | arrIndex: editItems"
                          [question]="col"
                          (rowEdited)="onRowEditChange(item)"
                        ></kkl-table-form>
                      </td>
                    </ng-template>
                  </ng-template>
                </ng-container>
              </tr>
              <tr *ngIf="localButtons?.length">
                <td style="font-weight: bolder">פעולות</td>
                <td
                  class="actions"
                  fxLayout="row wrap"
                  fxLayoutAlign="space-evenly"
                >
                  <ng-container
                    *ngIf="!(item | arrInclueds: editItems); else addButton"
                  >
                    <ng-container *ngFor="let butt of localButtons">
                      <!-- <ng-container *ngIf="element == expandedElement && butt.type === 'inlineExpand'; else closeExpand">
                        <button class="container-button" mat-raised-button color="primary" (click)="buttonClick(butt, item, 'actions')">
                          <kkl-icon [color]="'paper'" key="keyboard_arrow_up"></kkl-icon>
                        </button>
                      </ng-container>

                      <ng-template #closeExpand>
                        <ng-container *ngIf="butt.type !== 'inlineExpand'; else expandButton"> -->
                      <button
                        [ngClass]="{ expanded: item == expandedElement }"
                        [matTooltip]="butt.label"
                        mat-button
                        color="primary"
                        (click)="buttonClick(butt, item, 'actions')"
                      >
                        <kkl-icon
                          *ngIf="butt.icon"
                          [key]="butt.icon"
                        ></kkl-icon>
                      </button>
                      <!-- </ng-container>

                        <ng-template #expandButton>
                          <button [matTooltip]="butt.label" mat-button color="primary" (click)="buttonClick(butt, item, 'actions')">
                            <kkl-icon [size]="3" [color]="'primary'" *ngIf="butt.icon" [key]="butt.icon"></kkl-icon>
                          </button>
                        </ng-template>
                      </ng-template> -->
                    </ng-container>
                  </ng-container>
                  <ng-template #addButton>
                    <button
                      matTooltip="save"
                      mat-button
                      color="primary"
                      (click)="saveRowClick(item)"
                    >
                      <kkl-icon key="save"></kkl-icon>
                    </button>
                    <button
                      matTooltip="cancel"
                      mat-button
                      color="primary"
                      (click)="cancelRowClick(item)"
                    >
                      <kkl-icon key="cancel"></kkl-icon>
                    </button>
                  </ng-template>
                </td>
              </tr>
            </table>

            <div *ngIf="item == expandedElement" class="example-element-detail">
              <ng-container *ngIf="expandTemplate">
                <ng-template *ngTemplateOutlet="expandTemplate"></ng-template>
              </ng-container>
            </div>
          </mat-expansion-panel>
        </ng-container>
      </mat-accordion>
    </ng-container>
  </div>
  <div [hidden]="!paging">
    <mat-paginator
      #myPaging
      dir="ltr"
      fxLayout="row"
      fxLayoutAlign="center center"
      kklNewPagination
      [pageSizeOptions]="[10, 25, 100]"
      (page)="pageChanged($event)"
      aria-label="Select page"
    ></mat-paginator>
  </div>
</form>

<!-- </ng-container> -->
