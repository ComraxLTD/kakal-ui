<form [formGroup]="form">
  <div *ngIf="displayedColumns.length" class="mat-elevation-z8 table-wrapper">
    <mat-progress-bar mode="indeterminate" *ngIf="!dataTable"></mat-progress-bar>
    <table dir="rtl" mat-table [dataSource]="dataTable" matSort multiTemplateDataRows formArrayName="myRows">

      <ng-container *ngFor="let column of oneColumns" [matColumnDef]="column.key">
        <th mat-header-cell *matHeaderCellDef>
          <h3 mat-sort-header>{{column.label}}</h3>
        </th>
        <td mat-cell *matCellDef="let element; let i = dataIndex"
                    [style.display]="(i | tableGroupCell : column.group : spans) ? '' : 'none'"
                    [attr.rowspan]="(element == expandedElement)? (i | tableGroupCell : column.group : spans) : (i | tableGroupCell : column.group : spans)*2">
          <ng-container *ngIf="!(element | arrInclueds : editItems); else editBlock">
            <!-- <ng-container *ngIf="column.template">
              <mat-progress-bar mode="query" [value]="60"></mat-progress-bar>
              <ng-container *ngTemplateOutlet="column.template"></ng-container>
            </ng-container> -->
            <kkl-icon *ngIf="column.colIcon" [key]="column.colIcon.key"></kkl-icon>
            <span *ngIf="column.button; else withButton">
              <button mat-button color="primary" aria-label="Example icon button with a menu icon" (click)="buttonClick(column.button, element)">
                <kkl-icon [key]="column.button.icon.key"></kkl-icon>
                <span *ngIf="element[column.key]" style="white-space: pre-wrap;">
                  {{element[column.key] | tableCellPipe: column.controlType}}
                </span>
              </button>
            </span>
            <ng-template #withButton>
              <span *ngIf="element[column.key]" style="white-space: pre-wrap;">
                {{element[column.key] | tableCellPipe: column.controlType}}
              </span>
            </ng-template>
          </ng-container>
          <ng-template #editBlock>
            <ng-container >
              <kkl-table-form [formGroupName]="(element | arrIndex : editItems)" [question]="column"></kkl-table-form>
            </ng-container>
          </ng-template>
        </td>
      </ng-container>

      <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
          <div [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
            <div *ngIf="element == expandedElement" class="example-element-detail">
              <ng-container *ngIf="expandTemplate">
                <ng-template *ngTemplateOutlet="expandTemplate"></ng-template>
              </ng-container>
            </div>
          </div>
        </td>
      </ng-container>


      <ng-container matColumnDef="actions" class="center-butt">
        <th mat-header-cell *matHeaderCellDef>
          <button *ngIf="addButton" mat-button color="primary" aria-label="Example icon button with a menu icon" (click)="addNewRowGroup()">
            <kkl-icon key="add"></kkl-icon>
            {{addButton.label}}
          </button>
        </th>
        <td mat-cell *matCellDef="let element" class="center-butt">
          <ng-container *ngIf="!(element | arrInclueds : editItems); else addButton">
            <ng-container *ngFor="let butt of localButtons">
              <button mat-button color="primary" aria-label="Example icon button with a menu icon" (click)="buttonClick(butt, element)">
                <kkl-icon [key]="butt.icon.key"></kkl-icon>
                {{butt.label}}
              </button>
            </ng-container>
          </ng-container>
          <ng-template #addButton>
            <button mat-mini-fab color="primary" aria-label="Example icon button with a menu icon" (click)="saveRowClick(element)">
              <kkl-icon key="add"></kkl-icon>
            </button>
          </ng-template>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let element; columns: displayedColumns;"
          class="example-element-row"
          [class.example-expanded-row]="expandedElement === element"
          >
      </tr>
      <tr mat-row *matRowDef="let row; columns: expandTemplate? ['expandedDetail'] : []" class="example-detail-row"></tr>

      <!-- Row shown when there is no matching data. -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">No data</td>
      </tr>
    </table>

  </div>
  <div [hidden]="!paging">
    <mat-paginator dir="ltr" class="mat-elevation-z8" [pageSizeOptions]="[10, 25, 100]" aria-label="Select page"></mat-paginator>
  </div>
</form>
